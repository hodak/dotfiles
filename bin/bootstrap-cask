#!/usr/bin/env bash

set -e

# Ask for sudo access
sudo -v

brew_cask_install() {
  for app; do
    local app_name="$(echo $app | sed 's/-/ /')"
    if (ls /Applications/ | grep -i "$app_name" > /dev/null) || (brew cask list | grep $app > /dev/null); then
      echo "Already installed: $app_name"
    else
      echo "Installing: $app"
      brew cask install --appdir="/Applications" $app || true
    fi
  done
}

allow_control() {
  if [[ "$OSTYPE" =~ ^darwin13.*$ ]]; then
    for app; do
      APP_ID="$(osascript -e "id of app \"$app\"")"
      if [[ -n "$APP_ID" ]]; then
        sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "INSERT or REPLACE INTO access values ('kTCCServiceAccessibility', '$APP_ID', 0, 1, 0, NULL);"
      fi
    done
  else
    echo "allow_control works only on Mavericks"
  fi
}

autostart_hidden() {
  for app; do
    echo "Autostart: $app"
    osascript -e "tell application \"System Events\" to make login item at end with properties {path:\"/Applications/$app.app\", hidden:true}" > /dev/null
  done
}

run_app() {
  for app; do
    if test "$(osascript -e "tell application \"System Events\" to (name of processes) contains \"$app\"")" = "false"; then
      open -a "$app"
    fi
  done
}

# iterm2
brew_cask_install dropbox flux \
  firefox google-chrome \
  postico forklift disk-inventory-x postman overkill \
  slack anylist spark\
  alfred bettertouchtool karabiner-elements \
  spotify vlc air-video-server-hd qnapi calibre docker \

autostart_hidden Flux Dropbox 'Alfred 3' BetterTouchTool Karabiner-Elements

echo "Run default applications"
run_app Flux Dropbox 'Alfred 3' BetterTouchTool Karabiner-Elements

exit 0
